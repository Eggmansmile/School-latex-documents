% productie-macros.sty
% Shared macros for Productietechnologie documents
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{productie-macros}[2025/12/20 Productie macros: frm, formularium, fig]

% productie-macros.sty
% Shared macros for Productietechnologie documents
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{productie-macros}[2025/12/20 Productie macros: frm, formularium, fig]

% Load dependencies
\RequirePackage{etoolbox}
\RequirePackage{xstring} % string helpers for filename sanitation
\RequirePackage{tcolorbox}
\RequirePackage{caption}

% Default box colors (redefinable by user) - Updated for importance
\newcommand{\frmBoxBack}{blue!5}
\newcommand{\frmBoxFrame}{blue!40}
\newcommand{\frmBoxRule}{0.5pt}
\newcommand{\frmBoxArc}{3pt}
% Increase default inner padding for better readability
\newcommand{\frmBoxSep}{4pt}

% Accumulator for formularium entries
% We use etoolbox lists to manage chapters and their formulas
\newcommand{\FormulariumChapters}{}
\newcounter{FormulariumEntryCounter}

% Command written to .aux file to register a formula
% #1 = Chapter number/ID
% #2 = Label
% #3 = Math
% #4 = Note
% #5 = Reference ID (counter value)
\newcommand{\addformulariumentry}[5]{%
  % If this chapter hasn't been seen yet, add it to the list
  \ifinlist{#1}{\FormulariumChapters}{}{%
    \listgadd{\FormulariumChapters}{#1}%
    % Initialize the formula list for this chapter
    \global\csdef{ChapterFormulas@#1}{}%
  }%
  % Append the formula to the chapter's list
  \csxappto{ChapterFormulas@#1}{%
    \noexpand\item[\noexpand\textbf{#2}] \noexpand$\displaystyle \unexpanded{#3}$ --- \unexpanded{#4} {\noexpand(\noexpand\hyperref[frm:#5]{p.~\noexpand\pageref{frm:#5}})}\noexpand\par
  }%
}

% Main formula macro
% Usage: \frm{Label}{math}{note}
\newcommand{\frm}[3]{%
  % assign a stable id for this formula and place a label where it is printed
  \stepcounter{FormulariumEntryCounter}%
  \begin{tcolorbox}[
    colback=\frmBoxBack,
    colframe=\frmBoxFrame,
    boxrule=\frmBoxRule,
    leftrule=3pt, % Thick accent line on the left (standard tcolorbox)
    arc=\frmBoxArc,
    boxsep=\frmBoxSep,
    left=6pt, right=6pt, top=4pt, bottom=4pt
  ]
    \textbf{#1:}\par
    \vspace{2pt}
    {\centering\large $\displaystyle #2$\par}
    \vspace{4pt}
    {\footnotesize\itshape #3}\label{frm:\theFormulariumEntryCounter}%
  \end{tcolorbox}%
  % Write to aux file so it's available at next compile's start
  % We use \thechapter to capture the current chapter number
  \protected@write\@auxout{}{\string\addformulariumentry{\thechapter}{#1}{#2}{#3}{\theFormulariumEntryCounter}}%
}

% Make chapters keep number and title on the same line and avoid forcing a new page
\makeatletter
\patchcmd{\chapter}{\if@openright\cleardoublepage\else\clearpage\fi}{}{}{}
% Automatically label chapters by hooking into the counter increment
% This is more robust than patching \chapter or \@chapter which vary by class/package
\let\pm@orig@refstepcounter\refstepcounter
\renewcommand{\refstepcounter}[1]{%
  \pm@orig@refstepcounter{#1}%
  \ifdefstring{\thechapter}{\arabic{chapter}}{% Check if chapter is arabic (standard)
     \ifstrequal{#1}{chapter}{\label{chap:\thechapter}}{}%
  }{%
     \ifstrequal{#1}{chapter}{\label{chap:\thechapter}}{}%
  }%
}
\makeatother

% Internal helper to print one chapter's formulas
\newcommand{\printChapterFormulas}[1]{%
  \section*{Hoofdstuk #1: \nameref{chap:#1}}
  \begin{description}[leftmargin=3cm,labelsep=1em]
    \csuse{ChapterFormulas@#1}
  \end{description}
}

% Command to print the entire formularium
\newcommand{\printformularium}{%
  \chapter*{Formularium}
  \ifdefempty{\FormulariumChapters}{%
    \noindent\textit{Nog geen formules geregistreerd. Compileer het document tweemaal om de lijst te genereren.}%
  }{%
    \noindent\textit{Overzicht van formules per hoofdstuk.}
    \forlistloop{\printChapterFormulas}{\FormulariumChapters}%
  }%
}

% Backwards compatibility environment (deprecated, use \printformularium directly)
\newenvironment{formularium}{%
  \printformularium
}{%
}

% Figure helper (keep same signature as before)
\newcommand{\fig}[4][0.8\linewidth]{%
  \begin{figure}[ht]
    \centering
    \includegraphics[width=#1]{#2}
    \caption{#3}\label{#4}
  \end{figure}
}

% Auto-figure helper: sanitize filename and auto-create a label to avoid
% accidental labels like {fig:image.png} and to prevent literal "\n" paste issues.
% Usage: \autofig[<width>]{<path>}{<caption>} (width optional, default 0.8\linewidth)
\newcommand{\autofig}[3][0.8\linewidth]{%
  % Get candidate filename (handle both / and \\ separators safely)
  \def\pmFullPath{#2}% full path or filename
  \IfSubStr{\pmFullPath}{/}{\StrBehind{\pmFullPath}{/}[\pmFile]}{\def\pmFile{\pmFullPath}}%
  \IfSubStr{\pmFile}{\\}{\StrBehind{\pmFile}{\\}[\pmFile]}{}%
  % Remove extension if present, else keep whole name
  \IfSubStr{\pmFile}{.}{\StrBefore{\pmFile}{.}[\pmBasename]}{\def\pmBasename{\pmFile}}%
  % replace spaces and dots with underscores for safe label names
  \StrSubstitute{\pmBasename}{ }{_}[\pmBasename]
  \StrSubstitute{\pmBasename}{.}{_}[\pmBasename]
  % If basename ended up empty, fall back to a unique name using the current
  % figure counter so we never emit an empty label.
  \IfStrEq{\pmBasename}{}{\edef\pmLabel{fig:unnamed-\the\value{figure}}}{\edef\pmLabel{fig:\pmBasename}}%
  \begin{figure}[ht]
    \centering
    \includegraphics[width=#1]{#2}
    \caption{#3}\label{\pmLabel}
  \end{figure}
}

% Provide simple alias for tufte/classic to override box colors
\newcommand{\setfrmcolors}[2]{\renewcommand{\frmBoxBack}{#1}\renewcommand{\frmBoxFrame}{#2}}

% End of package


% End of package
